version: 2.1
jobs:
  build:
    machine: 
      image: circleci/classic:201808-01
    steps:
      - checkout
      - run:
          name: Install Snap
          command: |
            sudo apt-get install snapd
      - run:
          name: Create Kubernetes Cluster
          command: |
            kind create cluster
      - run:
          name: Launch Kubernetes with microk8s
          command: |
            sudo snap install microk8s --classic --channel=1.16/stable
            # wait until a k8s node is ready
            sleep 10
            n=0
            until [ $n -ge 10 ]
            do
              (/snap/bin/microk8s.kubectl get no | grep -z "Ready") && break
              n=$[$n+1]
              sleep 20
            done
            echo "Kubernetes cluster launched"
      - run:
          name: Run integration tests
          command: |
            /snap/bin/microk8s.kubectl config view --raw > /tmp/kubeconfig
            echo 'export KUBECONFIG=KUBECONFIG=/tmp/kubeconfig' >> $BASH_ENV
            source $BASH_ENV
            kubectl cluster-info
            cat $KUBECONFIG
            kubectl get pods --all-namespaces

            kubectl apply -f \
              https://github.com/operator-framework/operator-lifecycle-manager/releases/download/0.12.0/crds.yaml

            kubectl apply -f \
            https://github.com/operator-framework/operator-lifecycle-manager/releases/download/0.12.0/olm.yaml

            kubectl rollout status -w deployment/olm-operator -n olm
            kubectl rollout status -w deployment/catalog-operator -n olm
            kubectl rollout status -w deployment/packageserver -n olm

            kubectl get pods --all-namespaces

workflows:
  version: 2
  build:
    jobs:
      - build
